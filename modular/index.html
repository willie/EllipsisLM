<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Updated Viewport for Notch Support -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <!-- PWA and iOS Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EllipsisLM">
    <title>EllipsisLM</title>
    <link rel="apple-touch-icon" href="https://github.com/pacmanincarnate/EllipsisLM/blob/main/logo.png?raw=true">
    <link rel="icon" type="image/png" href="https://github.com/pacmanincarnate/EllipsisLM/blob/main/logo.png?raw=true">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Comic+Neue:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;1,400&family=Dancing+Script:wght@700&family=Domine:wght@400;700&family=EB+Garamond:ital,wght@0,400;1,400&family=Inter:wght@400;500;700&family=Lora:ital,wght@0,400;1,400&family=Nunito+Sans:ital,wght@0,400;1,400&family=Patrick+Hand&family=Prompt:wght@400;700&family=Roboto+Slab:wght@400;700&family=Source+Code+Pro:ital,wght@0,400;1,400&family=Titan+One&display=swap"
        rel="stylesheet">

    <!-- Application Styles -->
    <link rel="stylesheet" href="css/styles.css">



</head>




<body data-mode="none" class="bg-gray-900 h-full flex flex-col">

    <!-- Background Image Container -->
    <div id="global-background"
        class="fixed inset-0 -z-10 bg-gray-900 bg-[length:auto_100vh] bg-no-repeat bg-center transition-all duration-500">
    </div>

    <!-- Main Application Container -->
    <div class="w-full h-full flex flex-col glass-bg" id="app-container">

        <!-- Header: Contains navigation and global actions. Uses event delegation. -->
        <header class="mb-4 flex justify-between items-center" id="main-header">
            <!-- Desktop Header -->
            <div id="desktop-header" class="justify-between items-center w-full">

                <div class="flex items-center space-x-2">
                    <button data-action="open-modal" data-target="story-library-modal"
                        class="bg-gray-700/80 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="Story Library"
                        style="border-color: color-mix(in srgb, var(--chat-text-color) 50%, transparent); border-width: 2px;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h7"></path>
                            <path d="M4 6h16M4 12h16M4 18h7" stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"></path>
                            <path d="M18 18v-6" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                            <path d="M15 12h6" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                        </svg>
                    </button>

                    <input type="text" id="story-title-input" aria-label="Story Title"
                        class="text-2xl font-bold bg-transparent text-white p-1 rounded focus:outline-none focus:bg-black/20 w-96"
                        style="color: var(--chat-text-color);font-weight: 100; font-family: var(--chat-font-family);">
                </div>

                <div class="flex space-x-2">
                    <button data-action="quick-create-character"
                        class="bg-gray-700/40 hover:bg-indigo-500/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="Quickly Generate Character from Chat">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                            </path>
                        </svg>
                    </button>
                    <button data-action="open-modal" data-target="characters-modal"
                        class="bg-gray-700/40 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg" title="Characters
					"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.965 5.965 0 0112 13a5.965 5.965 0 013 1.803">
                            </path>
                        </svg></button>
                    <button data-action="open-modal" data-target="world-map-modal"
                        class="bg-gray-700/40 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="World Map"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 9m-6 4v.01">
                            </path>
                        </svg></button>
                    <button data-action="open-modal" data-target="knowledge-modal"
                        class="bg-gray-700/40 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="Knowledge"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z">
                            </path>
                        </svg></button>
                    <button data-action="check-world-info"
                        class="bg-gray-700/40 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="Update Static Memory"><svg class="w-6 h-6" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                            </path>
                        </svg></button>
                    <button data-action="open-modal" data-target="settings-modal"
                        class="bg-gray-700/40 hover:bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg"
                        title="Settings"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg></button>
                </div>
            </div>

            <!-- Mobile Header -->
            <div id="mobile-header" class="justify-end items-center w-full">
                <div class="relative" id="hamburger-menu-button-container">
                    <button id="hamburger-menu-button" data-action="toggle-mobile-menu" aria-label="Toggle Menu"
                        class="bg-gray-700/80 hover:bg-gray-600/80 text-white p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div id="mobile-menu"
                        class="hidden absolute right-0 mt-2 w-56 bg-gray-800/90 backdrop-blur-md rounded-lg shadow-xl z-50">
                        <a href="#" data-action="open-modal" data-target="story-library-modal"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block px-4 py-3 text-white hover:bg-gray-700">Story Library</a>
                        <div class="px-4 py-2 text-gray-400 text-sm font-bold border-t border-gray-700">Narrative
                            Settings</div>
                        <a href="#" data-action="quick-create-character"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Generate Character</a>
                        <a href="#" data-action="open-modal" data-target="characters-modal"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Characters</a>
                        <a href="#" data-action="open-modal" data-target="world-map-modal"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">World Map</a>
                        <a href="#" data-action="open-modal" data-target="knowledge-modal"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Knowledge</a>
                        <a href="#" data-action="check-world-info"
                            onclick="AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Update Static</a>
                        <div class="px-4 py-2 text-gray-400 text-sm font-bold border-t border-gray-700">Story Settings
                        </div>
                        <a href="#"
                            onclick="AppController.openSettingsToTab('appearance'); AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Appearance</a>
                        <a href="#"
                            onclick="AppController.openSettingsToTab('prompt'); AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Prompt</a>
                        <div class="px-4 py-2 text-gray-400 text-sm font-bold border-t border-gray-700">Global Settings
                        </div>
                        <a href="#"
                            onclick="AppController.openSettingsToTab('model'); AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Model</a>
                        <a href="#"
                            onclick="AppController.openSettingsToTab('personas'); AppController.toggleMobileMenu(); return false;"
                            class="block pl-8 pr-4 py-3 text-white hover:bg-gray-700">Users</a>
                    </div>
                </div>
            </div>
        </header>
        <!-- /Header -->

        <div id="mobile-header-elements">
            <input type="text" id="mobile-story-title-overlay" aria-label="Mobile Story Title"
                class="text-xl font-bold text-white truncate text-center bg-transparent focus:bg-black/20 w-1/2">
        </div>

        <!-- Main Content Area -->
        <main class="flex-grow min-h-0 flex flex-col relative">
            <div id="title-trigger-area" class="absolute top-0 left-0 w-full h-16 z-40" style="height: 2rem;"></div>
            <!-- Chat Window & Portrait -->
            <div id="chat-window-container"
                class="relative flex-grow p-2 flex min-h-0 bg-black/30 rounded-lg overflow-hidden"
                style="padding-bottom: revert; padding-top: revert;">
                <div id="cinematic-bg-1"
                    class="absolute inset-0 bg-cover bg-no-repeat bg-center transition-opacity duration-1000 pointer-events-none opacity-0">
                </div>
                <div id="cinematic-bg-2"
                    class="absolute inset-0 bg-cover bg-no-repeat bg-center transition-opacity duration-1000 pointer-events-none opacity-0">
                </div>
                <div id="chat-window" class="relative z-10 flex-grow overflow-y-auto"></div>
                <div id="character-portrait-container" class="flex-shrink-0 flex-col justify-center items-center"
                    style="padding-right: 0.5rem;"></div>
            </div>

            <!-- Chat Input & Controls -->
            <div id="chat-input-container" class="flex items-start space-x-2 sm:space-x-4"
                style="padding: 1rem; border-top: 1px solid; border-top-color: color-mix(in srgb, var(--chat-text-color) 50%, transparent);">
                <textarea id="chat-input"
                    class="flex-grow bg-black/30 border border-gray-800 rounded-lg p-2 color: black"
                    placeholder="Enter your message..." rows="4" style="color: var(--chat-text-color)"></textarea>
                <div class="flex flex-col space-y-2" style="width: 8.5rem;">
                    <select id="ai-character-selector" aria-label="Select Character"
                        class="bg-black/30 border border-gray-600 rounded-lg p-2 w-full mb-2 text-xs truncate"></select>
                    <div class="flex items-center justify-center space-x-1">
                        <button id="primary-action-btn"
                            class="bg-indigo-600/50 hover:bg-indigo-600/80 text-white font-bold p-2 rounded-lg transition-colors"
                            title="Send / Write for Me">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>

                        <button id="regen-btn"
                            class="bg-sky-600/40 hover:bg-sky-600/70 text-white font-bold p-2 rounded-lg transition-colors"
                            title="Regenerate / New Response">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                                <path d="M16 21h5v-5"></path>
                            </svg>
                        </button>

                        <button id="undo-btn"
                            class="bg-gray-600/40 hover:bg-gray-500/70 text-white font-bold p-2 rounded-lg transition-colors"
                            title="Undo Last Turn">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 14 4 9l5-5" />
                                <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Story Library Modal -->
    <div id="story-library-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="story-library-modal"></div>
        <div class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl relative flex flex-col"
            style="width: 100%; max-height: 100%">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Story Library</h2>
                <div class="flex space-x-2">
                    <button data-action="open-modal" data-target="io-hub-modal"
                        class="bg-teal-600/80 hover:bg-teal-700/80 text-white font-bold py-2 px-4 rounded-lg">Import /
                        Export</button>

                    <div class="relative inline-block text-left">
                        <button
                            onclick="event.stopPropagation(); document.getElementById('new-story-dropdown').classList.toggle('hidden')"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            New
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="new-story-dropdown"
                            class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 focus:outline-none border border-gray-700">
                            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                <button data-action="open-modal" data-target="gen-story-modal"
                                    onclick="document.getElementById('new-story-dropdown').classList.add('hidden')"
                                    class="w-full text-left text-gray-300 hover:bg-gray-700 hover:text-white px-4 py-3 text-sm flex items-center gap-3"
                                    role="menuitem">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <div>
                                        <span class="font-normal block">Generate Story</span>
                                    </div>
                                </button>
                                <button
                                    onclick="LibraryController.createNewStory(); document.getElementById('new-story-dropdown').classList.add('hidden')"
                                    class="w-full text-left text-gray-300 hover:bg-gray-700 hover:text-white px-4 py-3 text-sm flex items-center gap-3"
                                    role="menuitem">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 13h6m-3-3v6m5 5H6a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Create Blank Story
                                </button>
                            </div>
                        </div>
                    </div>

                    <button data-action="close-modal" data-id="story-library-modal" aria-label="Close"
                        class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="library-content-container" class="flex-grow flex min-h-0"></div>
            <!-- Footer Removed -->
        </div>
    </div>

    <!-- Story Generation Modal -->
    <div id="gen-story-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60" data-action="close-modal" data-id="gen-story-modal">
        </div>
        <div
            class="bg-gray-800/90 backdrop-blur-md rounded-lg shadow-2xl w-11/12 max-w-2xl relative flex flex-col p-6 border border-gray-600">
            <div class="flex justify-between items-start mb-4">
                <h2
                    class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">
                    AI Story Architect</h2>
                <button data-action="close-modal" data-id="gen-story-modal"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors"
                    title="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="gen-story-input-view">
                <label class="block text-sm text-gray-400 mb-2">What kind of story should we tell?</label>
                <textarea id="gen-story-prompt"
                    class="w-full bg-black/40 border border-gray-600 rounded-lg p-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 h-32 resize-none"
                    placeholder="e.g. A cyberpunk noir detective story on Mars where water is more expensive than gold."></textarea>
                <div class="flex justify-end mt-4 space-x-3">
                    <button data-action="close-modal" data-id="gen-story-modal"
                        class="px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors">Cancel</button>
                    <button data-action="gen-story-phase-1"
                        class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition-all">Draft
                        Concept</button>
                </div>
            </div>

            <div id="gen-story-approval-view" class="hidden flex-col space-y-4">
                <div class="bg-black/30 p-4 rounded-lg border border-gray-600 space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Title</label>
                        <input type="text" id="gen-approval-title-input" class="gen-input w-full font-bold text-lg">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Summary / Creator's
                            Note</label>
                        <textarea id="gen-approval-summary-input"
                            class="gen-input w-full h-48 resize-none text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Tags (comma
                            separated)</label>
                        <input type="text" id="gen-approval-tags-input"
                            class="gen-input w-full text-sm text-indigo-300">
                    </div>
                </div>

                <p class="text-xs text-gray-400 text-center">Refine the concept above. When ready, we will generate the
                    full world.</p>

                <div class="flex justify-between mt-4">
                    <button data-action="gen-story-retry"
                        class="px-4 py-2 rounded-lg text-red-300 hover:bg-red-900/50 hover:text-white transition-colors border border-red-900/50">Retry
                        / New Prompt</button>
                    <button data-action="gen-story-confirm"
                        class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/30 transition-all transform hover:scale-105">Build
                        This World</button>
                </div>
            </div>

            <div id="gen-story-progress-view" class="hidden flex-col items-center justify-center py-8 space-y-6">
                <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden relative">
                    <div id="gen-story-bar"
                        class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>
                <p id="gen-story-status" class="text-indigo-300 font-mono text-sm animate-pulse text-center">
                    Initializing creative subroutines...</p>
            </div>
        </div>
    </div>

    <!-- Import/Export Hub Modal -->
    <div id="io-hub-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50" data-action="close-modal" data-id="io-hub-modal">
        </div>
        <div id="io-hub-modal-content"
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-4xl relative flex flex-col max-h-[90vh]">
        </div>
    </div>

    <!-- Bulk Import Report Modal -->
    <div id="report-modal" class="fixed inset-0 z-[70] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60" data-action="close-modal" data-id="report-modal">
        </div>
        <div id="report-modal-content"
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-2xl relative flex flex-col max-h-[90vh]">
        </div>
    </div>

    <!-- Loading Spinner Overlay -->
    <div id="loading-spinner"
        class="fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex-col items-center justify-center hidden"
        style="display: none;">
        <div class="w-16 h-16 border-4 border-t-indigo-500 border-gray-600 rounded-full animate-spin"></div>
        <p id="spinner-message" class="mt-4 text-white font-semibold">Loading...</p>
    </div>

    <!-- Story Details Modal (Mobile) -->
    <div id="story-details-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="story-details-modal"></div>
        <div class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl relative flex flex-col"
            style="width: 100%; max-width: 1200px; height: 100%;">
            <div id="story-details-content-mobile" class="flex-grow flex flex-col min-h-0"></div>
        </div>
    </div>

    <!-- Characters Modal -->
    <div id="characters-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="characters-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 relative flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Character Roster</h2>
                <div class="flex items-center gap-2">
                    <button onclick="NarrativeController.addCharacter()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add
                        Character</button>
                    <button data-action="close-modal" data-id="characters-modal" aria-label="Close"
                        class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="characters-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </div>

    <!-- Individual Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50" data-action="close-modal"
            data-id="character-detail-modal"></div>
        <div id="character-detail-modal-content"
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl relative flex flex-col max-h-[90vh]"
            style="width: 95%; max-width: 1200px;"></div>
    </div>

    <!-- Knowledge Modal -->
    <div id="knowledge-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="knowledge-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl relative flex flex-col w-full max-w-6xl h-[90vh] overflow-hidden">
            <div class="p-4 flex-shrink-0 flex justify-between items-center border-b border-gray-700">
                <div class="flex space-x-4">
                    <button id="knowledge-tab-static" onclick="UIManager.switchKnowledgeTab('static')"
                        class="py-2 px-2 font-semibold text-lg border-b-2 border-indigo-500 text-white">Static</button>
                    <button id="knowledge-tab-dynamic" onclick="UIManager.switchKnowledgeTab('dynamic')"
                        class="py-2 px-2 font-semibold text-lg border-b-2 border-transparent text-gray-400 hover:text-white">Dynamic</button>
                </div>
                <div class="flex items-center space-x-2">
                    <button data-action="close-modal" data-id="knowledge-modal"
                        class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors"
                        title="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4 flex-grow overflow-hidden min-h-0">
                <div id="knowledge-static-content" class="h-full flex flex-col md:flex-row gap-4">
                    <div class="w-full md:w-1/3 flex flex-col h-1/3 md:h-full">
                        <div id="static-entries-list" class="bg-black/30 rounded-t-lg p-2 overflow-y-auto flex-grow">
                        </div>
                    </div>
                    <div id="static-entry-details"
                        class="w-full md:w-2/3 bg-black/30 rounded-lg p-4 overflow-y-auto flex-1 md:flex-none md:h-full">
                        <div id="static-entry-details-content" class="h-full">
                            <div class="text-gray-400 flex items-center justify-center h-full">Select a static
                                entry.
                            </div>
                        </div>
                    </div>
                </div>
                <div id="knowledge-dynamic-content" class="hidden h-full flex flex-col md:flex-row gap-4">
                    <div class="w-full md:w-1/3 flex flex-col h-1/3 md:h-full">
                        <div id="dynamic-entries-list" class="bg-black/30 rounded-t-lg p-2 overflow-y-auto flex-grow">
                        </div>
                    </div>
                    <div id="dynamic-entry-details"
                        class="w-full md:w-2/3 bg-black/30 rounded-lg p-4 overflow-y-auto flex-1 md:flex-none md:h-full">
                        <div id="dynamic-entry-details-content" class="h-full">
                            <div class="text-gray-400 flex items-center justify-center h-full">Select a dynamic
                                entry.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- World Map Modal -->
    <div id="world-map-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="world-map-modal"></div>
        <div id="world-map-modal-content"
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-6xl relative flex flex-col max-h-[90vh] min-h-[50vh]">
        </div>
    </div>

    <div id="location-details-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60" data-action="close-modal"
            data-id="location-details-modal"></div>
        <div
            class="bg-gray-800/90 backdrop-blur-md rounded-lg shadow-2xl w-11/12 max-w-4xl h-[85vh] relative flex flex-col border border-gray-600">
            <div
                class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 bg-black/20 rounded-t-lg">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Location Details
                </h3>
                <button data-action="close-modal" data-id="location-details-modal" aria-label="Close"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="location-details-content" class="p-6 overflow-y-auto flex-grow min-h-0"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="settings-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] relative flex flex-col">
            <div class="p-6 flex-shrink-0 border-b border-gray-700 flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-semibold mb-4">Settings</h2>
                    <div class="flex -mb-px space-x-4">
                        <button id="settings-tab-appearance" onclick="AppController.switchSettingsTab('appearance')"
                            class="pb-2 font-semibold border-b-2 border-indigo-500 text-white transition-colors">Appearance</button>
                        <button id="settings-tab-prompt" onclick="AppController.switchSettingsTab('prompt')"
                            class="pb-2 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">Prompt</button>
                        <button id="settings-tab-model" onclick="AppController.switchSettingsTab('model')"
                            class="pb-2 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">Model</button>
                        <button id="settings-tab-personas" onclick="AppController.switchSettingsTab('personas')"
                            class="pb-2 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">Users</button>
                    </div>
                </div>
                <button data-action="close-modal" data-id="settings-modal"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors -mt-2"
                    title="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow min-h-0" id="settings-content-container">...</div>
        </div>
    </div>

    <!-- Edit Response Modal -->
    <div id="edit-response-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="edit-response-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-[750px] h-[75vh] relative flex flex-col">
            <div class="p-4 border-b border-gray-700 flex-shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold">Edit Response</h3>
                <div class="flex items-center space-x-2">
                    <button id="edit-modal-save-button"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm">Save</button>
                    <button data-action="close-modal" data-id="edit-response-modal" aria-label="Close"
                        class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4 overflow-y-auto flex-grow flex flex-col min-h-0">
                <textarea id="edit-modal-input" aria-label="Edit Response Content"
                    class="w-full h-full bg-gray-900 border-gray-700 rounded-lg p-4 resize-none focus:bg-black/40 transition-colors"></textarea>
            </div>
        </div>
    </div>

    <!-- View Raw Prompt Modal -->
    <div id="view-raw-prompt-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0" data-action="close-modal" data-id="view-raw-prompt-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 relative flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Raw Prompt</h2>
                <button data-action="close-modal" data-id="view-raw-prompt-modal"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors"
                    title="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-gray-900">
                <pre id="raw-prompt-content" class="text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="p-4 bg-black/20 border-t border-gray-700 flex justify-end"><button data-action="close-modal"
                    data-id="view-raw-prompt-modal"
                    class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Done</button></div>
        </div>
    </div>

    <!-- Example Dialogue Modal -->
    <div id="example-dialogue-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50" data-action="close-modal"
            data-id="example-dialogue-modal"></div>
        <div
            class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 relative flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Edit Example Dialogue</h2>
                <button onclick="NarrativeController.addExampleDialogueTurn()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add
                    Turn</button>
            </div>
            <div id="example-dialogue-container" class="p-6 overflow-y-auto flex-grow space-y-4"></div>
            <div class="p-4 bg-black/20 border-t border-gray-700 flex justify-end">
                <button data-action="close-modal" data-id="example-dialogue-modal"
                    class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Done</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[70] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60" data-action="close-modal" data-id="confirmation-modal">
        </div>
        <div class="bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-md relative flex flex-col">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4">Are you sure?</h3>
                <p id="confirmation-modal-message" class="text-gray-300">This action cannot be undone.</p>
            </div>
            <div class="p-4 bg-black/20 border-t border-gray-700 flex justify-end space-x-4">
                <button data-action="close-modal" data-id="confirmation-modal"
                    class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmation-modal-confirm-button"
                    class="bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- OpenRouter Model Browser Modal -->
    <div id="openrouter-model-modal" class="fixed inset-0 z-[80] items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60" data-action="close-modal" data-id="openrouter-model-modal"></div>
        <div class="bg-gray-800/95 backdrop-blur-md rounded-lg shadow-xl w-11/12 max-w-2xl relative flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Browse OpenRouter Models</h3>
                <button data-action="close-modal" data-id="openrouter-model-modal" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 border-b border-gray-700">
                <input type="text" id="openrouter-model-search" class="w-full rounded-lg p-3 bg-gray-900/50 border border-gray-600 focus:border-indigo-500 focus:outline-none" placeholder="Search models by name or provider...">
            </div>
            <div id="openrouter-model-list" class="flex-1 overflow-y-auto p-2 min-h-[300px]">
                <div class="flex items-center justify-center h-full text-gray-400">
                    <span>Loading models...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden template for settings tabs -->
    <div id="settings-templates" class="hidden">

        <div id="settings-appearance-content" class="space-y-6">
            <div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="font-selector" class="text-gray-400 text-sm block mb-2">Chat Font</label>
                        <select id="font-selector" class="w-full rounded-lg p-2">
                            <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                (Standard)</option>
                            <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">Prompt
                                (Modern)</option>
                            <option value="'Nunito Sans', sans-serif" style="font-family: 'Nunito Sans', sans-serif">
                                Nunito Sans (Soft)</option>
                            <option value="'Source Code Pro', monospace"
                                style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)</option>
                            <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)</option>
                            <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold Serif)
                            </option>
                            <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">Roboto
                                Slab
                                (Slab)</option>
                            <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                Garamond
                                (Classic)</option>
                            <option value="'Cormorant Garamond', serif"
                                style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                            </option>
                            <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                Comic
                                Neue (Comic)</option>
                            <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                (Handwriting)</option>
                            <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                Patrick
                                Hand (Neat Hand)</option>
                            <option value="'Dancing Script', cursive" style="font-family: 'Dancing Script', cursive">
                                Dancing Script (Cursive)</option>
                            <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan One
                                (Chunky)</option>
                        </select>
                    </div>
                    <div><label for="chat-text-color" class="text-gray-400 text-sm block mb-2">Chat Text
                            Color</label><input type="color" id="chat-text-color" class="w-full rounded-lg p-1 h-10">
                    </div>
                </div>

                <details class="bg-black/20 rounded-lg p-2 mb-4 w-full">
                    <summary class="cursor-pointer font-semibold text-gray-300 hover:text-white select-none p-2">
                        Markdown Styling</summary>
                    <div class="grid grid-cols-2 gap-4 p-2 mt-2 border-t border-gray-700">

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Heading 1 Font</label>
                            <select id="md-h1-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Heading 1 Color</label><input type="color"
                                id="md-h1-color-input" class="w-full h-7 rounded cursor-pointer"></div>

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Heading 2 Font</label>
                            <select id="md-h2-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Heading 2 Color</label><input type="color"
                                id="md-h2-color-input" class="w-full h-7 rounded cursor-pointer"></div>

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Heading 3 Font</label>
                            <select id="md-h3-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Heading 3 Color</label><input type="color"
                                id="md-h3-color-input" class="w-full h-7 rounded cursor-pointer"></div>

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Bold Text Font</label>
                            <select id="md-bold-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Bold Text Color</label><input type="color"
                                id="md-bold-color-input" class="w-full h-7 rounded cursor-pointer">
                        </div>

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Italic Text Font</label>
                            <select id="md-italic-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Italic Text Color</label><input
                                type="color" id="md-italic-color-input" class="w-full h-7 rounded cursor-pointer">
                        </div>

                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Quote Font</label>
                            <select id="md-quote-font-input"
                                class="w-full rounded p-1 text-xs bg-gray-700 border border-gray-600">
                                <option value="">Use Default</option>
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif">Inter
                                    (Standard)</option>
                                <option value="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif">
                                    Prompt
                                    (Modern)</option>
                                <option value="'Nunito Sans', sans-serif"
                                    style="font-family: 'Nunito Sans', sans-serif">Nunito Sans (Soft)</option>
                                <option value="'Source Code Pro', monospace"
                                    style="font-family: 'Source Code Pro', monospace">Source Code Pro (Code)
                                </option>
                                <option value="'Lora', serif" style="font-family: 'Lora', serif">Lora (Serif)
                                </option>
                                <option value="'Domine', serif" style="font-family: 'Domine', serif">Domine (Bold
                                    Serif)
                                </option>
                                <option value="'Roboto Slab', serif" style="font-family: 'Roboto Slab', serif">
                                    Roboto
                                    Slab (Slab)</option>
                                <option value="'EB Garamond', serif" style="font-family: 'EB Garamond', serif">EB
                                    Garamond (Classic)</option>
                                <option value="'Cormorant Garamond', serif"
                                    style="font-family: 'Cormorant Garamond', serif">Cormorant Garamond (Elegant)
                                </option>
                                <option value="'Comic Neue', sans-serif" style="font-family: 'Comic Neue', sans-serif">
                                    Comic Neue (Comic)</option>
                                <option value="'Caveat', cursive" style="font-family: 'Caveat', cursive">Caveat
                                    (Handwriting)</option>
                                <option value="'Patrick Hand', cursive" style="font-family: 'Patrick Hand', cursive">
                                    Patrick Hand (Neat Hand)</option>
                                <option value="'Dancing Script', cursive"
                                    style="font-family: 'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Titan One', cursive" style="font-family: 'Titan One', cursive">Titan
                                    One
                                    (Chunky)</option>
                            </select>
                        </div>
                        <div><label class="text-xs text-gray-400 block mb-1">Quote Color</label><input type="color"
                                id="md-quote-color-input" class="w-full h-7 rounded cursor-pointer"></div>
                    </div>
                </details>

                <div>
                    <label for="background-image-upload" class="text-gray-400 text-sm block mb-2">Background
                        Image</label>
                    <span id="background-image-hint" class="text-xs text-gray-500 block mb-1"></span>
                    <div class="flex space-x-2">
                        <input type="file" id="background-image-upload" accept="image/*"
                            class="block w-full text-sm text-gray-400 file:mr-4 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-200 hover:file:bg-gray-600 cursor-pointer">
                        <button id="background-image-clear"
                            class="bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-1 px-3 rounded-lg">Clear</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div><label for="bubble-opacity-slider" class="text-gray-400 text-sm block mb-2">Chat Bubble
                            Opacity</label>
                        <div class="flex items-center space-x-4"><input type="range" id="bubble-opacity-slider"
                                class="w-full" min="0" max="1" step="0.05"><span id="bubble-opacity-value"
                                class="text-sm text-gray-400 w-12 text-right"></span></div>
                    </div>
                    <div><label for="blur-slider" class="text-gray-400 text-sm block mb-2">Background Blur
                            (px)</label>
                        <div class="flex items-center space-x-4"><input type="range" id="blur-slider" class="w-full"
                                min="0" max="20" step="1"><span id="blur-value"
                                class="text-sm text-gray-400 w-12 text-right"></span></div>
                    </div>
                    <div><label for="text-size-slider" class="text-gray-400 text-sm block mb-2">Text Size
                            (px)</label>
                        <div class="flex items-center space-x-4"><input type="range" id="text-size-slider"
                                class="w-full" min="12" max="36" step="1"><span id="text-size-value"
                                class="text-sm text-gray-400 w-12 text-right"></span></div>
                    </div>
                    <div><label for="bubble-image-size-slider" class="text-gray-400 text-sm block mb-2">Bubble Image
                            Size (px)</label>
                        <div class="flex items-center space-x-4"><input type="range" id="bubble-image-size-slider"
                                class="w-full" min="50" max="200" step="10"><span id="bubble-image-size-value"
                                class="text-sm text-gray-400 w-12 text-right"></span></div>
                    </div>
                </div>
                <label class="text-gray-400 text-sm block mt-4 mb-2">Character Image Display</label>
                <div class="flex space-x-4" id="character-image-display"><label
                        class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="imageDisplayMode"
                            value="none"><span>None</span></label><label
                        class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="imageDisplayMode"
                            value="cinematic_overlay"><span>Cinematic</span></label><label
                        class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="imageDisplayMode"
                            value="bubble"><span>Bubble</span></label></div>
            </div>
            <div class="mt-4 p-3 bg-black/20 rounded-lg border border-gray-700">
                <label class="flex items-center justify-between cursor-pointer">
                    <span class="text-gray-300 font-medium">Show Portrait Panel (Desktop)</span>
                    <div class="relative">
                        <input type="checkbox" id="show-portrait-panel-toggle" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </div>
                </label>
                <p class="text-xs text-gray-500 mt-1">If disabled, the chat window will be centered.</p>
            </div>
            <div class="pt-6 mt-4 border-t border-gray-700/50 text-center">
                <p id="build-info-display"
                    class="text-xs text-gray-600 font-mono uppercase tracking-widest opacity-75 select-all"></p>
            </div>
        </div>

        <div id="settings-prompt-content" class="space-y-2">
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Core Prompts
                </summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <h3 class="text-base font-medium mb-2">System Prompt (Global Fallback)</h3>
                    <p class="text-gray-400 text-sm mb-2">Used by AI characters who don't have their own specific
                        instructions.</p>
                    <textarea id="system-prompt-input" class="w-full rounded-lg p-2 resize-y" rows="4"></textarea>
                </div>
            </details>

            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Event Master
                </summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <h3 class="text-base font-medium mb-2">Event Master Prompt</h3>
                    <p class="text-gray-400 text-sm mb-2">Define the base instruction for the Event Master.</p>
                    <textarea id="event-master-prompt-input" class="w-full rounded-lg p-2 resize-y" rows="4"></textarea>

                    <div class="mt-3 flex items-center space-x-4">
                        <label for="event-master-prob-input" class="text-gray-400 text-sm font-bold">Trigger
                            Probability
                            (%):</label>
                        <input type="number" id="event-master-prob-input" min="0" max="100"
                            class="w-20 rounded-lg p-2 text-center" placeholder="15">
                    </div>
                </div>
            </details>
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Persona Generation
                    Prompt</summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <p class="text-gray-400 text-sm mb-2">Used by the AI button on a character's persona. Use
                        <code>{concept}</code> for the existing text.
                    </p><textarea id="prompt-persona-gen-input" class="w-full rounded-lg p-2 resize-y"
                        rows="4"></textarea>
                </div>
            </details>
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">World Map
                    Generation
                    Prompt</summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <p class="text-gray-400 text-sm mb-2">Used to generate the entire world map. Use
                        <code>{characters}</code>, <code>{static}</code>, and <code>{recent}</code>.
                    </p><textarea id="prompt-world-map-gen-input" class="w-full rounded-lg p-2 resize-y"
                        rows="6"></textarea>
                </div>
            </details>
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Location Prompt
                    Generation</summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <p class="text-gray-400 text-sm mb-2">Used to generate a location's detailed prompt. Use
                        <code>{name}</code> and <code>{description}</code>.
                    </p><textarea id="prompt-location-gen-input" class="w-full rounded-lg p-2 resize-y"
                        rows="4"></textarea>
                </div>
            </details>
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Memory Entry
                    Generation
                </summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <p class="text-gray-400 text-sm mb-2">Used for Static/Dynamic memory entries. Use
                        <code>{title}</code> and <code>{triggers}</code>.
                    </p><textarea id="prompt-entry-gen-input" class="w-full rounded-lg p-2 resize-y"
                        rows="4"></textarea>
                </div>
            </details>
            <details>
                <summary class="font-semibold text-lg cursor-pointer hover:text-indigo-300 py-2">Location Memory
                    Summary
                </summary>
                <div class="p-4 bg-black/20 rounded-b-lg">
                    <p class="text-gray-400 text-sm mb-2">Used to auto-summarize events when you leave a location.
                        Use
                        <code>{transcript}</code>.
                    </p><textarea id="prompt-location-memory-gen-input" class="w-full rounded-lg p-2 resize-y"
                        rows="4"></textarea>
                </div>
            </details>
            <div class="flex space-x-2 pt-4"><button onclick="NarrativeController.viewRawPrompt()"
                    class="bg-gray-600/80 hover:bg-gray-500/80 text-white font-bold py-2 px-4 rounded-lg">View Raw
                    Prompt</button><button data-action="open-modal" data-target="example-dialogue-modal"
                    class="bg-sky-600/80 hover:bg-sky-500/80 text-white font-bold py-2 px-4 rounded-lg">Edit Example
                    Dialogue</button></div>

            <div class="flex items-center justify-between mb-4 bg-black/20 p-3 rounded-lg border border-gray-700">
                <div>
                    <span class="text-gray-300 font-medium block">Enable AI Analysis</span>
                    <span class="text-xs text-gray-500">Auto-detects emotions and location changes. Disabling saves
                        tokens.</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="enable-analysis-toggle" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                    </div>
                </label>
            </div>
        </div>
        <div id="settings-personas-content" class="h-full flex flex-col">
            <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0 h-[60vh]">
                <div class="w-full md:w-1/3 flex flex-col h-full">
                    <div id="user-personas-list"
                        class="bg-black/30 rounded-t-lg p-2 overflow-y-auto flex-grow border border-gray-700 border-b-0">
                    </div>
                    <div class="flex-shrink-0 bg-black/30 rounded-b-lg p-2 border border-gray-700 border-t-0">
                        <button onclick="AppController.addUserPersona()"
                            class="w-full py-2 bg-gray-700 hover:bg-indigo-600 text-white rounded flex justify-center items-center transition-colors">
                            <span class="font-bold mr-2">New Persona</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="user-persona-details"
                    class="w-full md:w-2/3 bg-black/30 rounded-lg p-4 overflow-y-auto h-full border border-gray-700">
                    <div class="text-gray-400 flex items-center justify-center h-full">Select a persona to edit.
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-model-content" class="space-y-6">
            <p class="text-sm text-amber-300 bg-amber-900/50 p-3 rounded-lg -mt-2 mb-4"><strong>Note:</strong> These
                model settings are persistent and apply globally to all stories.</p>

            <div>
                <h3 class="text-lg font-medium mb-2">AI Provider</h3>
                <select id="api-provider-selector"
                    class="w-full rounded-lg p-2 bg-gray-700 border border-gray-600 text-white">
                    <option value="gemini">Gemini</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="koboldcpp">KoboldCPP</option>
                    <option value="lmstudio">LM Studio</option>
                </select>
            </div>
            <div id="gemini-settings">
                <h3 class="text-lg font-medium">Gemini API Settings</h3>
                <p class="text-gray-400 text-sm mb-2">Required for text generation.</p>
                <input type="password" id="gemini-api-key-input" class="w-full rounded-lg p-2 mb-3"
                    placeholder="Enter Gemini API key">

                <label class="text-gray-400 text-sm block mb-1">Model</label>
                <select id="gemini-model-selector"
                    class="w-full rounded-lg p-2 bg-gray-700 border border-gray-600 text-white">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast/Cheap)</option>
                    <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8B (Fastest)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (High Intelligence)</option>
                    <option value="gemini-1.0-pro">Gemini 1.0 Pro (Legacy)</option>
                </select>
            </div>
            <div id="openrouter-settings">
                <h3 class="text-lg font-medium">OpenRouter API Settings</h3>
                <p class="text-gray-400 text-sm mb-2">Your key and the model name.</p>
                <input type="password" id="openrouter-api-key-input" class="w-full rounded-lg p-2"
                    placeholder="Enter OpenRouter API key">

                <div class="mt-2 flex space-x-2">
                    <input type="text" id="openrouter-model-input" class="flex-grow rounded-lg p-2"
                        placeholder="Enter model name (e.g. anthropic/claude-3-opus)">
                    <button onclick="AppController.openOpenRouterModelBrowser()"
                        class="bg-gray-700 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg transition-colors"
                        title="Browse models">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                    <button onclick="AppController.saveOpenRouterModel()"
                        class="bg-gray-700 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg transition-colors"
                        title="Save to list">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                </div>

                <div id="openrouter-saved-models-list" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
            <div id="koboldcpp-settings">
                <h3 class="text-lg font-medium">KoboldCPP Settings</h3>
                <p class="text-amber-400 text-sm mb-2 bg-amber-900/50 p-2 rounded-md">Ensure your local server is
                    running.</p>
                <input type="text" id="koboldcpp-url-input" class="w-full rounded-lg p-2 mb-4"
                    placeholder="http://localhost:5001">
                <div>
                    <label for="koboldcpp-template-selector" class="text-gray-400 text-sm block mb-2">Prompt
                        Template</label>
                    <select id="koboldcpp-template-selector" class="w-full rounded-lg p-2">
                        <option value="none">None (Raw Text)</option>
                        <option value="llama3">Llama 3</option>
                        <option value="gemma">Gemma 2 (Google)</option>
                        <option value="phi3">Phi-3 (Microsoft)</option>
                        <option value="mistral">Mistral</option>
                        <option value="chatml">ChatML (Qwen/DeepSeek)</option>
                        <option value="alpaca">Alpaca</option>
                    </select>
                </div>
                <div>
                    <label for="koboldcpp-min-p-slider" class="text-gray-400 text-sm block mt-4 mb-2">Min P</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="koboldcpp-min-p-slider" class="w-full" min="0" max="1" step="0.05">
                        <span id="koboldcpp-min-p-value" class="text-sm text-gray-400 w-12 text-right"></span>
                    </div>
                </div>
                <div>
                    <label for="koboldcpp-dry-slider" class="text-gray-400 text-sm block mt-4 mb-2">DRY (Repetition
                        Penalty)</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="koboldcpp-dry-slider" class="w-full" min="0" max="1" step="0.05">
                        <span id="koboldcpp-dry-value" class="text-sm text-gray-400 w-12 text-right"></span>
                    </div>
                </div>
            </div>
            <div id="lmstudio-settings">
                <h3 class="text-lg font-medium">LM Studio Settings</h3>
                <p class="text-amber-400 text-sm mb-2 bg-amber-900/50 p-2 rounded-md">Ensure LM Studio is running
                    with a
                    model loaded. Default URL is http://localhost:1234</p>
                <div>
                    <label for="lmstudio-url-input" class="text-gray-400 text-sm block mb-2">LM Studio Server
                        URL</label>
                    <input type="text" id="lmstudio-url-input" class="w-full rounded-lg p-2"
                        placeholder="http://localhost:1234">
                </div>
            </div>
        </div>
    </div>

    <div id="lightbox-modal"
        class="fixed inset-0 z-[100] bg-black/90 hidden items-center justify-center backdrop-blur-sm">
        <button data-action="close-lightbox" aria-label="Close Lightbox"
            class="absolute top-4 right-4 text-white/50 hover:text-white p-2 z-50">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                </path>
            </svg>
        </button>

        <button data-action="lightbox-prev" aria-label="Previous Image"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white p-4 z-50 bg-black/20 hover:bg-black/50 rounded-full transition-all">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <img id="lightbox-image" class="max-h-[90vh] max-w-[90vw] object-contain shadow-2xl rounded-lg" src=""
            alt="Character Portrait">

        <button data-action="lightbox-next" aria-label="Next Image"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white p-4 z-50 bg-black/20 hover:bg-black/50 rounded-full transition-all">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <div id="lightbox-caption"
            class="absolute bottom-6 left-0 right-0 text-center text-white/80 font-bold text-xl drop-shadow-md">
        </div>
    </div>
















    <!-- Application Logic -->
    <script src="js/preamble.js"></script>
    <script src="js/services/utility.js"></script>
    <script src="js/services/db-service.js"></script>
    <script src="js/services/story-service.js"></script>
    <script src="js/services/state-manager.js"></script>
    <script src="js/services/api-service.js"></script>
    <script src="js/services/prompt-builder.js"></script>
    <script src="js/services/image-processor.js"></script>
    <script src="js/services/import-export-service.js"></script>
    <script src="js/ui/ui-manager.js"></script>
    <script src="js/controller.js"></script>
    <script src="js/app.js"></script>
</body>

</html>
